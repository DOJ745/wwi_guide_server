extends ../basic_layout
block content
    style.
        button#toggle-rep-password {
            position: absolute;
            top: 3px;
            right: 4px;
            z-index: 9;
            width: 28px;
            height: 30px;
            background: 0;
            border: 0;
        }

        button#toggle-rep-password:active,
        button#toggle-rep-password:focus,
        button#toggle-rep-password:hover {
            cursor: pointer;
        }

        button#toggle-rep-password:focus {
            outline: none !important;
        }

    div.container.h-100
        div.row.align-items-center.justify-content-center.h-100
            form#myForm.col-6.w-25(
                action="/api.wwi-guide.by/auth/reg-adm"
                method="POST")
                h1.text-center Introduce yourself
                div.form-group
                    label.form-label(for='loginField') Login
                    input#loginField.form-control(
                        type='text'
                        name='login'
                        placeholder='Username'
                        required=''
                        minlength=4
                        maxlength=48)
                label.form-label(for='passwordContainer') Password
                div#passwordContainer.input-group
                    input#passwordField.form-control.rounded(
                        type='password'
                        name='password'
                        required=''
                        minlength=6
                        maxlength=18
                        pattern="^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[@#$%^&+=_])(?=\\S+$).{6,18}$"
                        title="Require:\n" +
                        "\n- 1 letter (p)\n" +
                        "\n- 1 capitalize letter (P)\n" +
                        "\n- 1 unique symbol (@, #, $, %, ^, +, =, _)\n" +
                        "\n- 1 number\n" +
                        "\n- without space\n" +
                        "\n- 6-18 symbols")
                    button#toggle-password.d-none(type='button'
                        aria-label='Show password as plain text. Warning: this will display your password on the screen.')
                label.form-label(for='repeatPasswordContainer') Repeat password
                div#repeatPasswordContainer.input-group
                    input#repeatPasswordField.form-control.rounded(
                        type='password'
                        name='password'
                        required=''
                        minlength=6
                        maxlength=18)
                    button#toggle-rep-password.d-none(type='button'
                        aria-label='Show password as plain text. Warning: this will display your password on the screen.')
                div.row.form-group
                    p#response(hidden='' style='color: red') Error response
                div.row.form-signin
                    button#btnSubmit.col.btn.btn-primary.m-1(type='submit') Register
                    a.col.btn.btn-primary.m-1(href='/' role='button') Sign in

    script(src='/toggle-pass/js/show-password-toggle.js')
    script(type='text/javascript').
        let repPasswordToggle = document.getElementById("repeatPasswordField");
        repPasswordToggle.onclick = function () {
            document.getElementById("repeatPasswordField").classList.add("input-password");
            document.getElementById("toggle-rep-password").classList.remove("d-none");

            const passwordInput = document.getElementById("repeatPasswordField");
            const togglePasswordButton = document.getElementById("toggle-rep-password");

            togglePasswordButton.addEventListener("click", togglePassword);

            function togglePassword() {
                if (passwordInput.type === "password") {
                    passwordInput.type = "text";
                    togglePasswordButton.setAttribute("aria-label", "Hide password.");
                } else {
                    passwordInput.type = "password";
                    togglePasswordButton.setAttribute(
                        "aria-label",
                        "Show password as plain text. " +
                        "Warning: this will display your password on the screen."
                    )
                }
            }
        }

    script(type='text/javascript').
        $(document).ready(function () {
            const regForm = $("#myForm")
            const loginField = $("#loginField")
            const passwordField = $("#passwordField")
            const repPasswordField = $("#repeatPasswordField")
            const responseMsg = $("#response")

            let validateForm = function (event) {
                if (repPasswordField.val() !== passwordField.val()) {
                    responseMsg.html('Passwords are not equal!')
                    responseMsg.removeAttr('hidden')
                }
                else {
                    let formData = {
                        "login": loginField.val(),
                        "password": passwordField.val()
                    }

                    $.ajax({
                        url: regForm.attr('action'),
                        type: regForm.attr('method'),
                        headers: {'Accept': 'application/json'},
                        data: formData
                    })
                        .done((res) => {
                            responseMsg.attr('style', 'color: green')
                            responseMsg.removeAttr('hidden')
                            responseMsg.html(res.message)
                        })
                        .fail((jqXHR) => {
                            let errorData = $.parseJSON(jqXHR.responseText)
                            responseMsg.attr('style', 'color: red')
                            responseMsg.html(errorData.message)
                            responseMsg.removeAttr('hidden')
                        })
                }
                event.preventDefault()
            }
            regForm[0].addEventListener("submit", validateForm, true)
        })
